<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #fdfdfd;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        h1 {
            font-size: 2em;
            color: #2c3e50;
            text-align: left;
            padding-bottom: 10px;
            border-bottom: 2px solid #f5f0e8;
        }
        #drafts-section {
            margin-bottom: 30px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }
        #drafts-section h2 {
            margin-top: 0;
        }
        .draft-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .draft-item:last-child {
            border-bottom: none;
        }
        .draft-item button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .header-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        .form-section {
            background: #f5f0e8;
            padding: 20px;
            border-radius: 8px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, textarea:focus {
            border-color: #bda88c;
            outline: none;
        }
        #items-container .item {
            display: grid;
            grid-template-columns: 4fr 1fr 2fr 1fr 0.5fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            padding: 10px;
            background: #fdfdfd;
            border-radius: 4px;
        }
        .remove-item {
            background: #c0392b;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .remove-item:hover {
            background: #a93226;
        }
        .button-container {
            text-align: right;
            margin-top: 20px;
        }
        button, input[type="submit"] {
            background-color: #bda88c;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover, input[type="submit"]:hover {
            background-color: #a8957a;
        }
        #add-item {
            background-color: #2c3e50;
            margin-bottom: 20px;
        }
        #add-item:hover {
            background-color: #34495e;
        }
        hr { border: 0; border-top: 1px solid #eee; margin: 40px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quotation Generator</h1>

        <div id="drafts-section">
            <h2>Drafts</h2>
            <div id="drafts-list"></div>
        </div>

        <form id="quotation-form" action="/generate" method="post">
            <input type="hidden" id="quotation_id" name="quotation_id">
            <div class="header-grid">
                <div class="form-section">
                    <h2>From</h2>
                    <div class="form-group">
                        <label for="company_name">Name:</label>
                        <input type="text" id="company_name" name="company_name" value="Cheung Chi Yung">
                    </div>
                    <div class="form-group">
                        <label for="company_address">Address:</label>
                        <input type="text" id="company_address" name="company_address" value="No 30 Lane 2, Sha Kok Mei Village, Sai Kung">
                    </div>
                    <div class="form-group">
                        <label for="company_phone">Phone:</label>
                        <input type="text" id="company_phone" name="company_phone" value="6818 1891">
                    </div>
                    <div class="form-group">
                        <label for="company_email">Email:</label>
                        <input type="email" id="company_email" name="company_email" value="skmpig@gmail.com">
                    </div>
                </div>
                <div class="form-section">
                    <h2>To</h2>
                    <div class="form-group">
                        <label for="client_name">Client Name:</label>
                        <input type="text" id="client_name" name="client_name" value="袁生 袁太">
                    </div>
                    <div class="form-group">
                        <label for="client_address">Address:</label>
                        <input type="text" id="client_address" name="client_address" value="House 6 Louts Villa, 100 Chuk Yeung Rd Sai Kung">
                    </div>
                    <div class="form-group">
                        <label for="quotation_no">Quotation No:</label>
                        <input type="text" id="quotation_no" name="quotation_no" value="9/5/2024">
                    </div>
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date" name="date" value="2025-06-28">
                    </div>
                </div>
            </div>

            <hr>

            <h2>Items</h2>
            <div id="items-container">
                <div class="item item-header">
                    <span>Item Description</span>
                    <span>Units</span>
                    <span>Cost Per Unit</span>
                    <span></span>
                </div>
                <div class="item">
                    <input type="text" name="item_name[]" placeholder="Item Description" required>
                    <input type="number" name="quantity[]" value="1" min="0" step="any" placeholder="Units" required>
                    <input type="number" name="price[]" step="any" placeholder="Cost Per Unit" required>
                    <button type="button" class="remove-item">X</button>
                </div>
            </div>
            <button type="button" id="add-item">Add Item</button>

            <hr>

            <h2>Summary</h2>
            <div class="form-group">
                <label for="received">Received:</label>
                <input type="number" id="received" name="received" step="any" value="150000">
            </div>
            <div class="form-group">
                <label for="deposit_info">Deposit Info:</label>
                <input type="text" id="deposit_info" name="deposit_info" value="150k deposit received HSBC 055-122667-001 in name of Cheung Chi Yung">
            </div>

            <div class="button-container">
                <button type="button" id="new-quotation">New Quotation</button>
                <button type="button" id="save-draft">Save Draft</button>
                <input type="submit" value="Generate Quotation">
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadDrafts();

            document.getElementById('add-item').addEventListener('click', function() {
                addItem();
            });

            document.getElementById('items-container').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-item')) {
                    e.target.closest('.item').remove();
                }
            });

            document.getElementById('save-draft').addEventListener('click', saveDraft);
            document.getElementById('new-quotation').addEventListener('click', clearForm);

            document.getElementById('drafts-list').addEventListener('click', function(e) {
                const target = e.target;
                const draftId = target.closest('.draft-item')?.dataset.id;
                if (!draftId) return;

                if (target.classList.contains('load-draft')) {
                    loadQuotation(draftId);
                }
                if (target.classList.contains('delete-draft')) {
                    deleteQuotation(draftId);
                }
            });

            // Set date to today
            if (!document.getElementById('date').value) {
                document.getElementById('date').valueAsDate = new Date();
            }
        });

        function addItem(item = {}) {
            const itemsContainer = document.getElementById('items-container');
            const newItem = document.createElement('div');
            newItem.classList.add('item');
            newItem.innerHTML = `
                <input type="text" name="item_name[]" placeholder="Item Description" value="${item.name || ''}" required>
                <input type="number" name="quantity[]" value="${item.quantity || 1}" min="0" step="any" placeholder="Units" required>
                <input type="number" name="price[]" step="any" placeholder="Cost Per Unit" value="${item.price || ''}" required>
                <button type="button" class="remove-item">X</button>
            `;
            itemsContainer.appendChild(newItem);
        }

        function getFormData() {
            const form = document.getElementById('quotation-form');
            const formData = new FormData(form);
            const data = {
                id: formData.get('quotation_id'),
                company_name: formData.get('company_name'),
                company_address: formData.get('company_address'),
                company_phone: formData.get('company_phone'),
                company_email: formData.get('company_email'),
                client_name: formData.get('client_name'),
                client_address: formData.get('client_address'),
                quotation_no: formData.get('quotation_no'),
                date: formData.get('date'),
                received: formData.get('received'),
                deposit_info: formData.get('deposit_info'),
                items: []
            };

            const itemNames = formData.getAll('item_name[]');
            const quantities = formData.getAll('quantity[]');
            const prices = formData.getAll('price[]');

            for (let i = 0; i < itemNames.length; i++) {
                data.items.push({
                    name: itemNames[i],
                    quantity: quantities[i],
                    price: prices[i]
                });
            }
            return data;
        }

        function saveDraft() {
            const data = getFormData();
            fetch('/api/save_quotation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if(result.success) {
                    alert('Draft saved!');
                    document.getElementById('quotation_id').value = result.id;
                    loadDrafts();
                } else {
                    alert('Error saving draft: ' + result.error);
                }
            });
        }

        function loadDrafts() {
            fetch('/api/quotations')
                .then(response => response.json())
                .then(drafts => {
                    const draftsList = document.getElementById('drafts-list');
                    draftsList.innerHTML = '';
                    drafts.forEach(draft => {
                        const draftEl = document.createElement('div');
                        draftEl.classList.add('draft-item');
                        draftEl.dataset.id = draft.id;
                        draftEl.innerHTML = `
                            <span>${draft.client_name} - ${draft.quotation_no} (${new Date(draft.date).toLocaleDateString()})</span>
                            <div>
                                <button class="load-draft">Load</button>
                                <button class="delete-draft">Delete</button>
                            </div>
                        `;
                        draftsList.appendChild(draftEl);
                    });
                });
        }

        function loadQuotation(id) {
            fetch(`/api/get_quotation/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    clearForm(false);
                    document.getElementById('quotation_id').value = data.id;
                    document.getElementById('company_name').value = data.company_name;
                    document.getElementById('company_address').value = data.company_address;
                    document.getElementById('company_phone').value = data.company_phone;
                    document.getElementById('company_email').value = data.company_email;
                    document.getElementById('client_name').value = data.client_name;
                    document.getElementById('client_address').value = data.client_address;
                    document.getElementById('quotation_no').value = data.quotation_no;
                    document.getElementById('date').value = data.date;
                    document.getElementById('received').value = data.received;
                    document.getElementById('deposit_info').value = data.deposit_info;

                    const itemsContainer = document.getElementById('items-container');
                    // Remove all but the header
                    while (itemsContainer.children.length > 1) {
                        itemsContainer.removeChild(itemsContainer.lastChild);
                    }

                    const items = JSON.parse(data.items);
                    if (items && items.length > 0) {
                        items.forEach(item => addItem(item));
                    } else {
                        addItem(); // Add one empty item if none exist
                    }
                });
        }

        function deleteQuotation(id) {
            if (!confirm('Are you sure you want to delete this draft?')) return;

            fetch(`/api/delete_quotation/${id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Draft deleted!');
                        loadDrafts();
                        const currentId = document.getElementById('quotation_id').value;
                        if (currentId == id) {
                            clearForm();
                        }
                    } else {
                        alert('Error deleting draft: ' + result.error);
                    }
                });
        }

        function clearForm(fullClear = true) {
            document.getElementById('quotation-form').reset();
            document.getElementById('quotation_id').value = '';
            const itemsContainer = document.getElementById('items-container');
            while (itemsContainer.children.length > 1) {
                itemsContainer.removeChild(itemsContainer.lastChild);
            }
            addItem(); // Add a single blank item
            if (fullClear) {
                 // Optionally clear company details if needed, or reset to default
                document.getElementById('company_name').value = 'Cheung Chi Yung';
                document.getElementById('company_address').value = 'No 30 Lane 2, Sha Kok Mei Village, Sai Kung';
                document.getElementById('company_phone').value = '6818 1891';
                document.getElementById('company_email').value = 'skmpig@gmail.com';
            }
            document.getElementById('date').valueAsDate = new Date();
        }

        document.getElementById('add-item').addEventListener('click', function() {
            const itemsContainer = document.getElementById('items-container');
            const newItem = document.createElement('div');
            newItem.classList.add('item');
            newItem.innerHTML = `
                <input type="text" name="item_name[]" placeholder="Item Description" required>
                <input type="number" name="quantity[]" value="1" min="0" step="any" placeholder="Units" required>
                <input type="number" name="price[]" step="any" placeholder="Cost Per Unit" required>
                <button type="button" class="remove-item">X</button>
            `;
            itemsContainer.appendChild(newItem);
        });


    </script>
</body>
</html>